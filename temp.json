{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"botEnv": {
			"type": "string",
			"defaultValue": "prod"
		},
		"botId": {
			"type": "string"
		},
		"location": {
			"type": "string"
		},
		"sku": {
			"type": "string"
		},
		"kind": {
			"type": "string"
		},
		"siteName": {
			"type": "string"
		},
		"createNewStorage": {
			"type": "bool"
		},
		"storageAccountName": {
			"type": "string"
		},
		"storageAccountResourceId": {
			"type": "string",
			"defaultValue": ""
		},
		"appId": {
			"type": "string"
		},
		"appSecret": {
			"type": "string",
			"defaultValue": "blank"
		},
		"azureWebJobsBotFrameworkDirectLineSecret": {
			"type": "string",
			"defaultValue": ""
		},
		"appInsightsName": {
			"type": "string"
		},
		"skuName": {
			"type": "string",
			"allowedValues": [
				"F1",
				"D1",
				"B1",
				"B2",
				"B3",
				"S1",
				"S2",
				"S3",
				"P1",
				"P2",
				"P3",
				"P4"
			],
			"metadata": {
				"description": "Describes plan's pricing tier and instance size. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
			}
		},
		"skuCapacity": {
			"type": "int",
			"minValue": 1,
			"metadata": {
				"description": "Describes plan's instance count"
			}
		},
		"hostingPlanName": {
			"type": "string"
		},
		"zipUrl": {
			"type": "string",
			"defaultValue": ""
		},
		"proactiveZipUrl": {
			"type": "string",
			"defaultValue": ""
		},
		"endpoint": {
			"type": "string",
			"defaultValue": ""
		},
		"databaseName": {
			"type": "string"
		},
		"tier": {
			"type": "string"
		},
		"maxSizeBytes": {
			"type": "int"
		},
		"sampleName": {
			"type": "string",
			"defaultValue": ""
		},
		"zoneRedundant": {
			"type": "bool",
			"defaultValue": false
		},
		"EngagementId": {
			"type": "string"
		},
		"Owner": {
			"type": "string"
		},
		"DeploymentID": {
			"type": "string"
		},
		"licenseType": {
			"type": "string",
			"defaultValue": ""
		},
		"allowAzureIps": {
			"type": "bool",
			"defaultValue": true
		}
	},
	"variables": {
		"serverName": "euwdcbt001sql002",
		"storageAccountType": "Standard_LRS",
		"storageAccountId": "[if(or(parameters('createNewStorage'), equals('', parameters('storageAccountResourceId'))), resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('storageAccountResourceId'))]",
		"proactiveFunctionName": "[concat(parameters('siteName'), '-function')]",
		"config": {
			"scratch": {
				"stateEndpoint": "https://intercom-api-scratch.azurewebsites.net",
				"azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.scratch.botframework.com/",
				"blobStoreName": "icscratch",
				"openIdMetadata": "https://intercom-api-ppe.azurewebsites.net/v1/.well-known/openidconfiguration"
			},
			"ppe": {
				"stateEndpoint": "https://intercom-api-ppe.azurewebsites.net",
				"azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.ppe.botframework.com/",
				"blobStoreName": "intercomppe",
				"openIdMetadata": "https://intercom-api-ppe.azurewebsites.net/v1/.well-known/openidconfiguration"
			},
			"prod": {
				"stateEndpoint": "",
				"azureWebJobsBotFrameworkDirectLineEndpoint": "https://directline.botframework.com/",
				"blobStoreName": "connectorprod",
				"openIdMetadata": ""
			}
		},
		"botAppKinds": {
			"function": "functionapp",
			"sdk": "app",
			"designer": "app",
			"bot": ""
		},
		"botAppKind": "[variables('botAppKinds')[parameters('kind')]]",
		"currentConfig": "[variables('config')[toLower(parameters('botEnv'))]]",
		"siteHost": "[concat(parameters('siteName'), '.azurewebsites.net')]",
		"botEndpointConfig": {
			"bot": "[parameters('endpoint')]",
			"sdk": "[concat('https://', variables('siteHost'), '/api/messages')]",
			"designer": "[concat('https://', variables('siteHost'), '/api/messages')]",
			"function": "[concat('https://', variables('siteHost'), '/api/messages?code=', 'NYI')]"
		},
		"botEndpoint": "[variables('botEndpointConfig')[parameters('kind')]]"
	},
	"resources": [
		{
			"apiVersion": "2017-10-01-preview",
			"name": "[parameters('databaseName')]",
			"type": "Microsoft.Sql/servers/databases",
			"location": "[parameters('location')]",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Database"
			},
			"dependsOn": [
				"[variables('serverName')]"
			],
			"properties": {
				"collation": "SQL_Latin1_General_CP1_CI_AS",
				"maxSizeBytes": "[parameters('maxSizeBytes')]",
				"sampleName": "[parameters('sampleName')]",
				"zoneRedundant": "[parameters('zoneRedundant')]",
				"licenseType": "[parameters('licenseType')]"
			},
			"sku": {
				"name": "[parameters('skuName')]",
				"tier": "[parameters('tier')]"
			}
		},
		{
			"condition": "[parameters('allowAzureIps')]",
			"apiVersion": "2014-04-01-preview",
			"dependsOn": [
				"[concat('Microsoft.Sql/servers/', variables('serverName'))]"
			],
			"location": "[parameters('location')]",
			"name": "AllowAllWindowsAzureIps",
			"properties": {
				"endIpAddress": "0.0.0.0",
				"startIpAddress": "0.0.0.0"
			},
			"type": "firewallrules"
		},
		{
			"type": "Microsoft.Storage/storageAccounts",
			"condition": "[parameters('createNewStorage')]",
			"name": "[parameters('storageAccountName')]",
			"apiVersion": "2015-05-01-preview",
			"location": "[parameters('location')]",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot Storage Account"
			},
			"properties": {
				"accountType": "[variables('storageAccountType')]"
			}
		},
		{
			"type": "Microsoft.Web/serverfarms",
			"name": "[parameters('hostingPlanName')]",
			"location": "[parameters('location')]",
			"apiVersion": "2016-09-01",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot App Service Plan"
			},
			"sku": {
				"name": "[parameters('skuName')]",
				"capacity": "[parameters('skuCapacity')]"
			},
			"properties": {
				"name": "[parameters('hostingPlanName')]"
			}
		},
		{
			"name": "[parameters('appInsightsName')]",
			"type": "microsoft.insights/components",
			"kind": "web",
			"apiVersion": "2014-04-01",
			"location": "[parameters('location')]",
			"tags": {
				"[concat('hidden-link:', resourceId('Microsoft.BotService/botServices/', parameters('botId')))]": "Resource",
				"[concat('hidden-link:', resourceId('Microsoft.Web/sites/', parameters('siteName')))]": "Resource",
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot App Insights"
			},
			"properties": {
				"ApplicationId": "[parameters('botId')]"
			}
		},
		{
			"name": "[parameters('siteName')]",
			"type": "Microsoft.Web/sites",
			"apiVersion": "2015-08-01",
			"condition": "[not(equals(parameters('zipUrl'), ''))]",
			"location": "[parameters('location')]",
			"kind": "[variables('botAppKind')]",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot Web App"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
			],
			"properties": {
				"name": "[parameters('siteName')]",
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlanName'))]",
				"siteConfig": {
					"appSettings": [
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listkeys(variables('storageAccountId'), '2015-05-01-preview').key1,';')]"
						},
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listkeys(variables('storageAccountId'), '2015-05-01-preview').key1,';')]"
						},
						{
							"name": "WEBSITE_NODE_DEFAULT_VERSION",
							"value": "6.9.1"
						},
						{
							"name": "BotEnv",
							"value": "[parameters('botEnv')]"
						},
						{
							"name": "BotId",
							"value": "[parameters('botId')]"
						},
						{
							"name": "MicrosoftAppId",
							"value": "[parameters('appId')]"
						},
						{
							"name": "MicrosoftAppPassword",
							"value": "[parameters('appSecret')]"
						},
						{
							"name": "BotStateEndpoint",
							"value": "[variables('currentConfig').stateEndpoint]"
						},
						{
							"name": "BotOpenIdMetadata",
							"value": "[variables('currentConfig').openIdMetadata]"
						},
						{
							"name": "UseTableStorageForConversationState",
							"value": "true"
						},
						{
							"name": "BotDevAppInsightsKey",
							"value": "[reference(resourceId('microsoft.insights/components/', parameters('appInsightsName')), '2015-05-01').InstrumentationKey]"
						},
						{
							"name": "BotDevAppInsightsName",
							"value": "[parameters('appInsightsName')]"
						},
						{
							"name": "BotDevAppInsightsAppId",
							"value": "[reference(resourceId('microsoft.insights/components/', parameters('appInsightsName')), '2015-05-01').AppId]"
						},
						{
							"name": "QnAKnowledgebaseId",
							"value": ""
						},
						{
							"name": "QnAAuthKey",
							"value": ""
						},
						{
							"name": "QnAEndpointHostName",
							"value": ""
						}
					],
					"cors": {
						"allowedOrigins": [
							"https://botservice.hosting.portal.azure.net",
							"https://hosting.onecloud.azure-test.net/"
						]
					}
				}
			},
			"resources": [
				{
					"apiVersion": "2016-03-01",
					"type": "config",
					"name": "connectionstrings",
					"dependsOn": [
						"[parameters('siteName')]"
					],
					"properties": {
						"DefaultConnection": {
							"value": "[concat('Data Source=tcp:', reference(concat('Microsoft.Sql/servers/', variables('serverName'))).fullyQualifiedDomainName, ',1433;Initial Catalog=', parameters('databaseName'), ';User Id=', parameters('administratorLogin'), '@', reference(concat('Microsoft.Sql/servers/', variables('serverName'))).fullyQualifiedDomainName, ';Password=', parameters('administratorLoginPassword'), ';')]",
							"type": "SQLAzure"
						}
					}
				},
				{
					"name": "MSDeploy",
					"type": "Extensions",
					"apiVersion": "2015-02-01",
					"condition": "[not(equals(parameters('zipUrl'), ''))]",
					"dependsOn": [
						"[concat('Microsoft.Web/Sites/', parameters('siteName'))]"
					],
					"properties": {
						"packageUri": "[parameters('zipUrl')]",
						"dbType": "None",
						"connectionString": "",
						"setParameters": {
							"IIS Web Application Name": "[parameters('siteName')]"
						}
					}
				}
			]
		},
		{
			"apiVersion": "2016-03-01",
			"type": "Microsoft.Web/sites",
			"condition": "[not(equals(parameters('proactiveZipUrl'), ''))]",
			"name": "[variables('proactiveFunctionName')]",
			"location": "[parameters('location')]",
			"kind": "functionapp",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot Web App"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]"
			],
			"properties": {
				"siteConfig": {
					"appSettings": [
						{
							"name": "AzureWebJobsDashboard",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listkeys(variables('storageAccountId'), '2015-05-01-preview').key1,';')]"
						},
						{
							"name": "AzureWebJobsStorage",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listkeys(variables('storageAccountId'), '2015-05-01-preview').key1,';')]"
						},
						{
							"name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
							"value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('storageAccountName'),';AccountKey=',listkeys(variables('storageAccountId'), '2015-05-01-preview').key1,';')]"
						},
						{
							"name": "WEBSITE_CONTENTSHARE",
							"value": "[toLower(variables('proactiveFunctionName'))]"
						},
						{
							"name": "FUNCTIONS_EXTENSION_VERSION",
							"value": "~1"
						},
						{
							"name": "AzureWebJobsBotFrameworkDirectLineSecret",
							"value": "[parameters('azureWebJobsBotFrameworkDirectLineSecret')]"
						},
						{
							"name": "AzureWebJobsBotFrameworkDirectLineEndpoint",
							"value": "[variables('currentConfig').azureWebJobsBotFrameworkDirectLineEndpoint]"
						}
					]
				}
			},
			"resources": [
				{
					"name": "MSDeploy",
					"type": "Extensions",
					"apiVersion": "2015-02-01",
					"condition": "[not(equals(parameters('proactiveZipUrl'), ''))]",
					"dependsOn": [
						"[concat('Microsoft.Web/Sites/', variables('proactiveFunctionName'))]"
					],
					"properties": {
						"packageUri": "[parameters('proactiveZipUrl')]"
					}
				}
			]
		},
		{
			"apiVersion": "2017-12-01",
			"type": "Microsoft.BotService/botServices",
			"name": "[parameters('botId')]",
			"location": "global",
			"kind": "[parameters('kind')]",
			"tags": {
				"EngagementID": "[parameters('EngagementId')]",
				"Owner": "[parameters('Owner')]",
				"Deployment ID": "[parameters('DeploymentID')]",
				"Purpose": "Bot"
			},
			"sku": {
				"name": "[parameters('sku')]"
			},
			"properties": {
				"name": "[parameters('botId')]",
				"displayName": "[parameters('botId')]",
				"endpoint": "[variables('botEndpoint')]",
				"msaAppId": "[parameters('appId')]",
				"developerAppInsightsApplicationId": "[parameters('appInsightsName')]",
				"developerAppInsightKey": "[reference(resourceId('microsoft.insights/components/', parameters('appInsightsName')), '2015-05-01').InstrumentationKey]"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
				"[resourceId('Microsoft.Web/sites/', parameters('siteName'))]",
				"MSDeploy",
				"[resourceId('microsoft.insights/components/', parameters('appInsightsName'))]"
			]
		}
	]
}
